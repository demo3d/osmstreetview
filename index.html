<!DOCTYPE html> 

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <link   type="text/css" rel="stylesheet" href="styles/global.css" media="screen" />
    <link   type="text/css" rel="stylesheet" href="styles/leaflet.css" />

    <style>
        @media (min-width: 1440px) {
              #leftnav { float:left; margin-right:20px; width:400px}
              #content { margin-left: 420px; margin-right:10px; }
              #map_div { width:400px; height:300px }
          }

        @media (max-width: 1440px) {
              #leftnav { margin-left: 10px; margin-right:50px; } /*leave a 50px bar on the right to */
              #content { margin-left: 10px; margin-right:50px; } /*allow for mouse and touch scrolling */
              #map_div { width:100%; height:600px }
          }

    </style>

    <script type="text/javascript" src="leaflet.js"></script>
    <script type="text/javascript" src="metatile.js"></script>
    <script type="text/javascript" src="mapLayer.js"></script>
    <script type="text/javascript" src="buildings.js"></script>
    <script type="text/javascript" src="skydome.js"></script>
    <script type="text/javascript" src="poly2tri.js"></script>

	<script type="text/javascript" src="gl-matrix.js" ></script>
	<script type="text/javascript" src="glu.js" ></script>

    <script src="webgl-debug.js"></script>
    
	<script id="map-shader-fs" type="x-shader/x-fragment">
		precision mediump float;
        varying vec2 texCoordV;
        uniform sampler2D tex;
		void main(void) {
		    float dx = (texCoordV.s - 0.5)*2.0;
		    float dy = (texCoordV.t - 0.5)*2.0;
		    
		    float radiusSquared = dx*dx + dy*dy;
            if ( radiusSquared > 1.0)
                discard;

            float alpha = radiusSquared < 0.9 ? 1.0 : (1.0 - radiusSquared)*10.0;

            gl_FragColor = texture2D(tex, texCoordV.st);
            gl_FragColor[3] = clamp(alpha, 0.0, 1.0);
		}
	</script>

	<script id="texture-shader-fs" type="x-shader/x-fragment">
		precision mediump float;
        varying vec2 texCoordV;
        uniform sampler2D tex;
		void main(void) {
            gl_FragColor = texture2D(tex, texCoordV.st);
		}
	</script>

	<script id="building-shader-fs" type="x-shader/x-fragment">
		precision mediump float;
        varying vec3 texCoordV;
        varying vec3 normal;
        varying vec3 worldPosition;
        
        uniform sampler2D tex;
        //uniform float height;
		void main(void) {
		    const float c = 0.02;

            vec3 vView = normalize(- worldPosition); //direction vector from surface to camera (camera is always at (0,0,0) )
            float diffuse = abs(0.5 * dot(vView, normal))+0.3;
            
            gl_FragColor = vec4( vec3(diffuse), 1.0);
            
            if (texCoordV.z == 0.0) //HACK: z==0 --> building height was just guessed --> tint it red
                gl_FragColor = gl_FragColor * vec4(1.0, 0.8, 0.9, 1.0);

		}
	</script>
	
	<script id="shader-vs" type="x-shader/x-vertex">
		attribute vec3 vertexPosition;
        attribute vec2 vertexTexCoords;  			
		
		uniform mat4 modelViewMatrix;
		uniform mat4 perspectiveMatrix;

        varying vec2 texCoordV;

		void main(void) {
			gl_Position = perspectiveMatrix * modelViewMatrix * vec4(vertexPosition, 1.0);
			texCoordV = vertexTexCoords;
		}
	</script>

	<script id="building-shader-vs" type="x-shader/x-vertex">
		attribute vec3 vertexPosition;
        attribute vec3 vertexTexCoords; 			
        attribute vec3 vertexNormal;
		
		uniform mat4 modelViewMatrix;
		uniform mat4 perspectiveMatrix;

        varying vec3 texCoordV;
        varying vec3 normal;
        varying vec3 worldPosition;

		void main(void) {
			gl_Position = perspectiveMatrix * modelViewMatrix * vec4(vertexPosition, 1.0);
			worldPosition = vertexPosition; //pass through untransformed
			texCoordV = vertexTexCoords;
			normal = vertexNormal;
		}
	</script>

	
    <script type="text/javascript">
    "use strict"    
    function init()
    {
        map = L.map('map_div').setView([52.15, 11.63], 14); //global 

        map.on("click", onMapClick);

        /*L.tileLayer('http://ipsum4.rbuch703.de/osm/{z}/{x}/{y}.png', {
            attribution: 'OpenStreetMap',
            maxZoom: 19, minZoom:1
        }).addTo(map);*/
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'OpenStreetMap',
            maxZoom: 19, minZoom:1
        }).addTo(map);

        L.control.scale({imperial:false, position:"topright"}).addTo(map);
        
	    initGl();  //initialize webGL canvas

		//register event handlers
		webGlCanvas.onclick = renderScene;
		webGlCanvas.onmousedown = onMouseDown;
		webGlCanvas.onmouseup   = onMouseUp;
		webGlCanvas.onmouseout  = onMouseUp;
		webGlCanvas.onmousemove = onMouseMove;
		document.body.onresize = onResize;


        var url = document.URL;
        if (url.indexOf("?") >= 0)
        {
            var query = url.substring(url.indexOf("?")+1);
        }
        else
            //default to a view of the Berlin Bundestag
            var query = "lat=52.518542911605294&lng=13.372035026550293&lookx=0.9991195257047053&looky=-0.04202442195745082";
            
        //console.log("query is '%s'", query);
        var parts = query.split("&");
        var res = {};
        for (var i in parts)
        {
            var part = parts[i];
            var kv = part.split("=");
            if (kv.length == 2)
            {
                res[kv[0]] = parseFloat(kv[1]);
            }
        }
        
        if (res.lat && res.lng)
        {
            var e = {};
            e.latlng = {lat:res.lat, lng:res.lng};
            
            if (res.lookx && res.looky) //if look direction is also given
            {
                //console.log("contains eye position");
                lookDir[0] = res.lookx;
                lookDir[1] = res.looky;
                var len = lookDir[0]*lookDir[0] + lookDir[1]*lookDir[1] + lookDir[2]*lookDir[2];
                lookDir[0]/=len;
                lookDir[1]/=len;
                lookDir[2]/=len;
            }
            
            map.panTo(L.latLng(res.lat, res.lng));
            onMapClick(e);
        }

    }    

    var map;
    var mapPlane;
    var mapBuildings;
    var mapSkyDome;
    var gl;
    var eye,lookDir,position;
    var positionMarker;
    
    function updateHistoryState()
    {
        var url = document.URL;
        if (url.indexOf("?") >= 0) // already contains a query string
            url = url.substring(0, url.indexOf("?"));
        
        url += "?lat="+position.lat+"&lng="+position.lng+"+&lookx="+lookDir[0]+"&looky="+lookDir[1];
        history.replaceState(null, document.title, url);
    }
    
    function onMapClick(e)
    {
        position = e.latlng;
        map.panTo(e.latlng);
        
        mapPlane = new MapLayer(gl, position);
        mapPlane.onLoaded = renderScene;
        
        mapBuildings = new Buildings(gl, position);
        mapBuildings.onLoaded = renderScene;
        
        if (positionMarker)
            map.removeLayer(positionMarker);
        
        positionMarker = L.marker([position.lat, position.lng])
        
        positionMarker.addTo(map).bindPopup("You are here");
        //console.log("Setting map center to %o", position);
        updateHistoryState();
    }   

	var x,y;
    var down = false;	
    		
	function onMouseDown(e)
	{
	    if (e.button != 0) 
	        return;

	    x = e.clientX;
	    y = e.clientY;
	    down = true;
	}
	
	function onMouseUp(e)
	{
	    if (e.button != 0) 
	        return;
	    down = false;
	    //renderScene();
	}
	
    function onMouseMove(e)
	{
	   if (! down) return;
	   var dx = e.clientX - x;
	   var dy = e.clientY - y;
	   
	   if (Math.abs(dx) < 5 && Math.abs(dy) < 5)
	        return;
	   x = e.clientX;
	   y = e.clientY;
	   
	   var rotMat = mat4.create();
	   mat4.rotateZ(rotMat, rotMat, -dx/100);
	   vec3.transformMat4(lookDir, lookDir, rotMat);
	   
	   /*var tmp = vec3.create();
	   vec3.scale(tmp, lookDir, -dy);
	   vec3.add(eye, eye, tmp);*/

       updateHistoryState();	   
	   renderScene();
	}	
	
	/**
	 * Initialises WebGL and creates the 3D scene.
	 */
	function initGl()
	{
        //create context
		gl = webGlCanvas.getContext("webgl") || webGlCanvas.getContext("experimental-webgl");
		if(!gl)
		{
			alert("Your browser does not support 3D views (WebGL)");
			return;
		}
		gl = WebGLDebugUtils.makeDebugContext(gl);
		
		gl.clearColor(0.5, 0.5, 0.5, 1.0);

		gl.clearDepth(1.0);
		gl.enable(gl.DEPTH_TEST);
		gl.depthFunc(gl.LEQUAL);
		
		gl.enable(gl.BLEND);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

        onResize();
	
        //view setup 
        eye = [0,0,2.0];
        lookDir = [-0.41759445514800125, 0.9086334100609345, 0];

        mapSkyDome = new SkyDome(gl);
        mapSkyDome.onLoaded = renderScene;

        //renderScene();
	}
	

	function onResize()
	{
	    //console.log("resize triggered");
	    //webGlCanvas.clientHeight = webGlCanvas.clientWidth / 16 * 9;
        webGlCanvas.height = webGlCanvas.clientHeight;
        webGlCanvas.width  = webGlCanvas.clientWidth;
	    /*if (webGlCanvas.clientWidth > 1000)
	    {
	        webGlCanvas.height /= 1.5;
	        webGlCanvas.width /=1.5;
	    } */
	    
	    if (gl)
	    {
	        //console.log("redraw triggered");
			gl.viewport(0, 0, webGlCanvas.width, webGlCanvas.height);
			renderScene();
		}
	}	
	
	function renderScene()
	{
	    if (!gl || !eye || !lookDir) //not yet initialized
	        return;
	    //console.log("?lat="+position.lat+"&lng="+position.lng+"&lookx="+lookDir[0]+"&looky="+lookDir[1]);
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        //determine look-at point
	    var lookAt = vec3.create();
        vec3.add(lookAt, eye, lookDir);
	
		var modelViewMatrix = mat4.create();
		mat4.lookAt(modelViewMatrix, eye,  lookAt,[0, 0, 1]);
		mat4.scale(modelViewMatrix, modelViewMatrix, [1,-1,1]);//negate y coordinate to make positive y go downward

        //setup projection matrix (model-view will be set up on a per-frame basis in renderScene() )
	    
	    var projectionMatrix = mat4.create();
	    mat4.perspective(projectionMatrix, 45/180*Math.PI, webGlCanvas.width / webGlCanvas.height, 1.0, 10000.0);

        
        if (mapPlane)
            mapPlane.render(modelViewMatrix, projectionMatrix);
        
        if (mapBuildings)
            mapBuildings.render(modelViewMatrix, projectionMatrix);
        
        if (mapSkyDome)
            mapSkyDome.render(modelViewMatrix, projectionMatrix);
            
		gl.flush();
	}
	
    </script>
    <title>Open Street View</title>
</head>

<body onload="init()"  > <!-- style ="padding: 0px; margin: 0px;" -->
<h2 style="">Open Street View</h2>


<div id="leftnav" style="">
<div id="explanation"> 
    <p>Click on any location on the map to see a 3D view of the world as seen from that position. Then click and drag the 3D view with your mouse to look around.</p>
    <p>Buildings missing or inaccurate? <a href="howToEdit.html" target="_blank">Add them yourself</a>!</p>
</div>
<div id="map_div"> </div>

<div id="explanation2" >
<p>Example locations:
<ul>

    <li><a href="index.html?lat=51.49792127437513&lng=-0.12039899826049805+&lookx=-0.828674009800797&looky=0.5597454542471598">London (House of Parliament)</a></li>
    <li><a href="index.html?lat=40.76622259343548&lng=-73.97189140319824+&lookx=-0.9463230728925572&looky=-0.32320061171669856">New York City (Central Park)</a></li>
    <li><a href="index.html?lat=38.90011502071927&lng=-77.0364761352539+&lookx=-0.12454456879248807&looky=-0.9922077921439103">Washington (The White House)</a></li>
    <li><a href="index.html?lat=36.11320847328812&lng=-115.17272472381592+&lookx=-0.960931697572018&looky=0.27678200541790926">Las Vegas (The Bellagio)</a></li>

    <li><a href="index.html?lat=52.50918106676593&lng=13.376015424728394&lookx=-0.843616861360829&looky=0.5369484419008503">Berlin (Potsdamer Platz)</a></li>
    <li><a href="index.html?lat=52.518542911605294&lng=13.372035026550293&lookx=0.9991195257047053&looky=-0.04202442195745082">Berlin (Bundestag, Brandenburger Tor)</a></li>

    <li><a href="index.html?lat=51.342923474812814&lng=12.382020950317381+&lookx=-0.3712468810809316&looky=0.9285318347615598">Leipzig (Main Station)</a></li>
    <li><a href="index.html?lat=52.13942567533446&lng=11.639671325683594&lookx=-0.2771210999768672&looky=-0.9608356743971576">Magdeburg (Universitätsplatz)</a></li>
</ul>
</p>
</div>
</div>

<div id="content" >
    <!-- <div id="nav" style="background-color:#EEE; position:fixed; width:75%; top:50px; bottom:0px; right: 0px; overflow-y:scroll">-->
		<canvas id="webGlCanvas" style="width:100%; height:auto;background:black" ></canvas>
        <div style="font-size:80%; font-style:italic">
The map and building geometry are &copy;OpenStreetMap contributors and are <a href="http://www.openstreetmap.org/copyright">licensed</a> under the Creative Commons BY-SA (map) and Open Database License (buildings) licenses.</div>

    </div>
</div> 


</body>


</html>
